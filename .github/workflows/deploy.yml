name: PHP CI Pipeline - Build & Push Docker Image # Ù†Ø§Ù… Ø§ÛŒÙ† ÙØ±Ø¢ÛŒÙ†Ø¯ (Pipeline)

on:
  push:
    branches:
      - master # Ø§ÛŒÙ† ÙØ±Ø¢ÛŒÙ†Ø¯ ÙÙ‚Ø· Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒ Ø´ÙˆØ¯ Ú©Ù‡ Ú©Ø¯ Ø¨Ù‡ Ø´Ø§Ø®Ù‡ 'master' Ø§Ø±Ø³Ø§Ù„ (push) Ø´ÙˆØ¯

env:
  # Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®ØªÙ† ØªÚ¯ ØªØµÙˆÛŒØ± Ø¯Ø§Ú©Ø±
  # Ù†Ø§Ù… Ù…Ø®Ø²Ù†: Ù…Ø«Ù„Ø§Ù‹ my-login-project
  REPO_NAME: ${{ github.event.repository.name }} 
  # Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± GitHub Container Registry (GHCR)
  PHP_IMAGE_TAG: ghcr.io/${{ secrets.CR_USERNAME }}/${{ github.event.repository.name }}/php:latest 

jobs:
  # 1. Ù…Ø±Ø­Ù„Ù‡ CI: Ø³Ø§Ø®ØªØŒ ØªÚ¯â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± PHP Ø¨Ù‡ GHCR
  build-and-push-php:
    runs-on: ubuntu-latest # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÛŒÚ© Ù…Ø§Ø´ÛŒÙ† Ù…Ø¬Ø§Ø²ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4 # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø² Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨

      # --- Ù…Ø±Ø­Ù„Ù‡ Ø§Ø®ØªÛŒØ§Ø±ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ (ÙØ¹Ù„Ø§Ù‹ Ú©Ø§Ù…Ù†Øª Ø´Ø¯Ù‡ Ø§Ø³Øª) ---
      # Ø§Ú¯Ø± ØªØ³Øª PHP Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©Ø§Ù…Ù†Øª Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø±ÛŒØ¯ ØªØ§ Ø§Ø¬Ø±Ø§ Ø´ÙˆÙ†Ø¯
      # - name: Run PHP Unit Tests
      #   run: docker run --rm -v $(pwd):/app php:8.2-cli-alpine vendor/bin/phpunit
      # --------------------------------------------------------

      - name: ğŸ”‘ Login to GHCR (GitHub Container Registry)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.CR_USERNAME }} # Ø§Ø² SecretÛŒ Ú©Ù‡ Ø³Ø§Ø®ØªÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆØ¯
          password: ${{ secrets.CR_TOKEN }} # Ø§Ø² SecretÛŒ Ú©Ù‡ Ø³Ø§Ø®ØªÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆØ¯

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 # Ø§Ø¨Ø²Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡ Ø³Ø§Ø²ÛŒ Ø³Ø§Ø®Øª Ø¯Ø§Ú©Ø±

      - name: ğŸ—ï¸ Build and Push PHP Docker Image
        uses: docker/build-push-action@v5
        with:
          context: . # Ø¨Ù‡ Ø¯Ø§Ú©Ø± Ù…ÛŒâ€ŒÚ¯ÙˆÛŒØ¯ Ø§Ø² Ø±ÛŒØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
          push: true # ØªØµÙˆÛŒØ± Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ù‡ Ø±Ø¬ÛŒØ³ØªØ±ÛŒ Ø¨ÙØ±Ø³Øª (Push)
          tags: ${{ env.PHP_IMAGE_TAG }} # Ø§Ø² ØªÚ¯ÛŒ Ú©Ù‡ Ø¯Ø± Ø¨Ø§Ù„Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯ÛŒÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
          file: ./Dockerfile # Ø¢Ø¯Ø±Ø³ ÙØ§ÛŒÙ„ Dockerfile Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒ Ú©Ù†Ø¯

  # Ù…Ø±Ø­Ù„Ù‡ Ø§Ø³ØªÙ‚Ø±Ø§Ø± (CD) Ø­Ø°Ù Ø´Ø¯Ù‡
